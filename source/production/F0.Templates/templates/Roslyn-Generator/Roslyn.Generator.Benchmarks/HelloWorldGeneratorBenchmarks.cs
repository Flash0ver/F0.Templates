using BenchmarkDotNet.Attributes;
using F0.CodeAnalysis.CSharp.Benchmarking;

namespace Roslyn.Generator.Benchmarks
{
	public class HelloWorldGeneratorBenchmarks
	{
#if (Roslyn3_8 || Roslyn3_9)
		private readonly CSharpSourceGeneratorBenchmark<HelloWorldGenerator> benchmark = new();
#else
		private readonly CSharpIncrementalGeneratorBenchmark<HelloWorldGenerator> benchmark = new();
#endif

		[GlobalSetup]
		public void Setup()
		{
			string code = @"
using Roslyn.Generated;

namespace Benchmarks
{
	internal static partial class Greeter
	{
		[HelloWorld]
		public static partial string GetHelloWorld();
	}

	internal partial struct AdditionalGreeter
	{
		[HelloWorld]
		public static partial string GetHelloWorld();
	}
}
";

			string additionalCode = @"
using Roslyn.Generated;

namespace Benchmarks
{
	internal static partial class Greeter
	{
		[HelloWorld]
		public static partial string GetAdditionalHelloWorld();
	}

	internal partial struct AdditionalGreeter
	{
		[HelloWorld]
		public static partial string GetAdditionalHelloWorld();
	}
}
";

#if (Roslyn3_8 || Roslyn3_9)
			benchmark.Initialize(new CSharpSourceGeneratorBenchmarkInitializationContext
#else
			benchmark.Initialize(new CSharpIncrementalGeneratorBenchmarkInitializationContext
#endif
			{
				Source = code,
				AdditionalSources = { additionalCode },
			});
		}

		[Benchmark]
		public object Generate()
		{
			return benchmark.Invoke();
		}

		[GlobalCleanup]
		public void Cleanup()
		{
			string attribute = @"// <auto-generated/>
#nullable enable

namespace Roslyn.Generated
{
	[global::System.CodeDom.Compiler.GeneratedCodeAttribute(""Roslyn.Generator"", ""1.0.0.0"")]
	[global::System.AttributeUsage(global::System.AttributeTargets.Method, AllowMultiple = false)]
	internal sealed class HelloWorldAttribute : global::System.Attribute
	{
	}
}
";

		string generated = @"// <auto-generated/>
#nullable enable

namespace Benchmarks
{
	partial class Greeter
	{
		public static partial string GetHelloWorld() => ""Hello, World!"";
		public static partial string GetAdditionalHelloWorld() => ""Hello, World!"";
	}
}
";

			string additionalGenerated = @"// <auto-generated/>
#nullable enable

namespace Benchmarks
{
	partial struct AdditionalGreeter
	{
		public static partial string GetHelloWorld() => ""Hello, World!"";
		public static partial string GetAdditionalHelloWorld() => ""Hello, World!"";
	}
}
";

#if (Roslyn3_8 || Roslyn3_9)
			benchmark.Inspect(new CSharpSourceGeneratorBenchmarkInspectionContext
#else
			benchmark.Inspect(new CSharpIncrementalGeneratorBenchmarkInspectionContext
#endif
			{
				Source = ("HelloWorldAttribute.g.cs", attribute),
				AdditionalSources =
				{
					("Benchmarks.Greeter.HelloWorld.g.cs", generated),
					("Benchmarks.AdditionalGreeter.HelloWorld.g.cs", additionalGenerated),
				},
			});
		}
	}
}
