using BenchmarkDotNet.Attributes;
using F0.CodeAnalysis.CSharp.Benchmarking;

namespace Roslyn.Generator.Benchmarks
{
	public class HelloWorldGeneratorBenchmarks
	{
#if (Roslyn3_8 || Roslyn3_9)
		private readonly CSharpSourceGeneratorBenchmark<HelloWorldGenerator> benchmark = new();
#else
		private readonly CSharpIncrementalGeneratorBenchmark<HelloWorldGenerator> benchmark = new();
#endif

		[GlobalSetup]
		public void Setup()
		{
			string code = @"
using Roslyn.Generated;

namespace Benchmarks
{
	internal static partial class Greeter
	{
		[HelloWorld]
		public static partial string GetHelloWorld();
	}
}
";

#if (Roslyn3_8 || Roslyn3_9)
			benchmark.Initialize(new CSharpSourceGeneratorBenchmarkInitializationContext
#else
			benchmark.Initialize(new CSharpIncrementalGeneratorBenchmarkInitializationContext
#endif
			{
				Source = code,
			});
		}

		[Benchmark]
		public object Generate()
		{
			return benchmark.Invoke();
		}

		[GlobalCleanup]
		public void Cleanup()
		{
			string attribute = @"// <auto-generated/>
#nullable enable

namespace Roslyn.Generated
{
	[global::System.CodeDom.Compiler.GeneratedCodeAttribute(""Roslyn.Generator"", ""1.0.0.0"")]
	[global::System.AttributeUsage(global::System.AttributeTargets.Method, AllowMultiple = false)]
	internal sealed class HelloWorldAttribute : global::System.Attribute
	{
	}
}
";

		string generated = @"// <auto-generated/>
#nullable enable

namespace Benchmarks
{
	partial class Greeter
	{
		public static partial string GetHelloWorld() => ""Hello, World!"";
	}
}
";

#if (Roslyn3_8 || Roslyn3_9)
			benchmark.Inspect(new CSharpSourceGeneratorBenchmarkInspectionContext
#else
			benchmark.Inspect(new CSharpIncrementalGeneratorBenchmarkInspectionContext
#endif
			{
				Source = ("HelloWorldAttribute.g.cs", attribute),
				AdditionalSources = { ("Greeter.HelloWorld.g.cs", generated) },
			});
		}
	}
}
